# Claude Code Conversation File Structure Analysis

**Workflow:** Investigation of Claude Code conversation/session storage structures
**Date:** 2026-01-21
**Scope:** Global ~/.claude directory + grimoire project conversations

---

## Directory Organization

### Global Claude .claude Directory: ~/.claude/

The global Claude Code configuration stores conversation data and metadata:

- **debug/** (183 files)
  - UUID-named .txt files containing debug logs
  - Example: `00766c39-b861-43c0-962a-5f8bacbc081a.txt`
  - Contains initialization logs, config loading, LSP setup, etc.

- **todos/** (211 files)
  - Task tracking storage
  - Format: `{sessionId}-agent-{agentId}.json`
  - Currently minimal content (appears as empty arrays [])
  - Used by TodoWrite tool for workflow task tracking

- **projects/** (key storage)
  - Project-specific conversations organized by absolute path
  - Naming: `-{project-absolute-path}`
  - Example: `-Users-teazyou-dev-grimoire` maps to `/Users/teazyou/dev/grimoire`
  - Currently contains 10 projects tracked

- **history.jsonl** (single file)
  - Global command and paste clipboard history
  - JSONL format (one JSON object per line)
  - Used for command palette history across all projects

- **file-history/** (85 folders)
  - File modification tracking for change snapshots
  - Separate folder per conversation

- **paste-cache/** (25 folders)
  - Clipboard cache for recently pasted content
  - One folder per conversation or session

- **session-env/** (75 folders)
  - Environment variable snapshots captured at session start
  - Preserves shell environment state

- **shell-snapshots/** (31 folders)
  - Shell configuration and environment state snapshots
  - Created at session initialization
  - Example file: `snapshot-zsh-1768568291753-bdz5a3.sh`

- **ide/** (IDE state)
  - IDE lock files and session state
  - Contains `.lock` files like `35881.lock`

- **Other directories**
  - cache/, downloads/, telemetry/, statsig/
  - Standard caching and telemetry

### Project Storage Structure: ~/.claude/projects/{-project-path}/

```
.claude/projects/-Users-teazyou-dev-grimoire/
├── {sessionId-1}.jsonl                    # Main conversation file
├── {sessionId-1}/
│   ├── subagents/
│   │   ├── agent-{agentId-1}.jsonl      # Subagent conversation
│   │   └── agent-{agentId-2}.jsonl      # Another subagent
│   └── tool-results/                     # Tool execution cache
├── {sessionId-2}.jsonl                    # Another conversation
├── {sessionId-2}/
│   ├── subagents/
│   │   └── agent-{agentId}.jsonl
│   └── tool-results/
└── ...
```

**Grimoire Project Storage Stats:**
- 77 total conversations (sessionId files/folders)
- Largest conversation: 9.3MB (e031b65e-5bf0-4914-9487-0bae354319f5.jsonl)
- Total lines across all conversations: ~3883
- Multiple subagent conversations per main conversation

### Project-Specific .claude Folders

Projects can have local `.claude/` directories:

**grimoire project:**
- `/Users/teazyou/dev/grimoire/.claude/commands/` - project-specific commands
- `/Users/teazyou/dev/grimoire/dot-claude/.claude/` - backup/alternative location

---

## Conversation File Format: JSONL

All conversations use **JSON Lines (JSONL)** format:
- One valid JSON object per line
- Newline-delimited for streaming and appending
- Enables incremental reads and efficient storage

### Core Message Schema

Every message is a JSON object with this structure:

```json
{
  "parentUuid": "uuid-string or null",
  "isSidechain": boolean,
  "userType": "external|internal",
  "cwd": "/working/directory/path",
  "sessionId": "uuid-string",
  "version": "2.1.9",
  "gitBranch": "main",
  "type": "user|assistant|summary|file-history-snapshot",
  
  "message": {
    "role": "user|assistant",
    "content": "string or array of content objects"
  },
  
  "uuid": "message-uuid",
  "timestamp": "2026-01-21T13:34:00.000Z",
  
  // Optional fields:
  "slug": "url-friendly-slug",
  "agentId": "agent-identifier",        // Present only in subagent conversations
  "isMeta": boolean,                    // true for metadata/command messages
  "requestId": "req_01XXXXXX",         // Anthropic API request ID
  "model": "claude-opus-4-5-20251101",  // Model used for response
  "id": "msg_01XXXXXX"                  // Anthropic message ID
}
```

### Special Message Types

#### 1. file-history-snapshot
Records file state at a point in conversation:

```json
{
  "type": "file-history-snapshot",
  "messageId": "658ca84e-e655-4544-b63b-758a241a7d05",
  "snapshot": {
    "messageId": "658ca84e-e655-4544-b63b-758a241a7d05",
    "trackedFileBackups": {},
    "timestamp": "2026-01-21T06:21:56.409Z"
  },
  "isSnapshotUpdate": false
}
```

#### 2. summary
Automatic summaries of conversation sections:

```json
{
  "type": "summary",
  "summary": "UX Design Workflow Creation Setup",
  "leafUuid": "4ebfb8e9-0781-48b1-8954-969f6ea87eb7"
}
```

### Content Structure

Message content can be:

**Simple string (user input):**
```json
"message": {
  "role": "user",
  "content": "What is the project structure?"
}
```

**Array of content objects (rich content):**
```json
"message": {
  "role": "assistant",
  "content": [
    {
      "type": "text",
      "text": "Response text here"
    },
    {
      "type": "tool_use",
      "id": "toolu_01XXXXX",
      "name": "Read",
      "input": {
        "file_path": "/path/to/file"
      }
    },
    {
      "tool_use_id": "toolu_01XXXXX",
      "type": "tool_result",
      "content": "Tool output here"
    }
  ]
}
```

---

## Sub-Agent Conversation Structure and Linking

### How Sub-Agents Work

**Triggering Sub-Agent:**
1. User invokes a Skill in main conversation
   - Example: User runs `/skill-name` or Skill tool call
2. Claude Code creates subagent conversation
   - Creates folder: `{sessionId}/subagents/`
   - Creates file: `agent-{agentId}.jsonl`
   - Subagent is a separate Claude instance

**Sub-Agent Message Flow:**
1. Messages stored in `{sessionId}/subagents/agent-{agentId}.jsonl`
2. Subagent has its own conversation thread
3. Results bubble back to main conversation

### Key Linking Fields

**Parent Conversation (main conversation file):**
```json
{
  "sessionId": "37134a38-e014-4319-bfb8-7b57cf032824",
  "isSidechain": false,
  "type": "assistant",
  "message": {
    "content": [
      {
        "type": "tool_use",
        "name": "Skill",
        "input": {
          "skill": "bmad:bmm:workflows:create-architecture"
        }
      }
    ]
  }
}
```

**Sub-Agent Conversation Messages:**
```json
{
  "sessionId": "37134a38-e014-4319-bfb8-7b57cf032824",  // SAME as parent
  "isSidechain": true,                                    // KEY: marks as subagent
  "agentId": "a1027c4",                                   // Unique agent ID
  "parentUuid": "1e9899f6-3c84-4db1-86ba-5b64c386f892",  // Links back to parent
  "type": "user|assistant",
  "message": { ... }
}
```

### Linking Discovery Algorithm

To find all subagents for a conversation:

1. Get main conversation: `~/.claude/projects/-{project-path}/{sessionId}.jsonl`
2. Scan all messages in that file
3. Find message with `"type": "tool_use"` and `"name": "Skill"`
4. Record the spawning message's UUID
5. Look for corresponding `{sessionId}/subagents/agent-{agentId}.jsonl`
6. Subagent messages will have:
   - Same `sessionId`
   - `isSidechain: true`
   - `parentUuid` matching the spawning message

**Critical observation:** There is NO explicit "parent conversation ID" field in subagent messages. Discovery requires:
- Knowing the sessionId (inherited)
- Scanning the parent conversation file for Skill invocations
- Matching the parentUuid to find the exact spawning message

### Sub-Agent Storage Locations

```
Grimoire example:
~/.claude/projects/-Users-teazyou-dev-grimoire/
├── 37134a38-e014-4319-bfb8-7b57cf032824.jsonl     # Main conversation
└── 37134a38-e014-4319-bfb8-7b57cf032824/
    └── subagents/
        └── agent-a1027c4.jsonl                     # Subagent conversation
```

---

## Metadata Fields Reference

### Message Identification

| Field | Type | Purpose | Example |
|-------|------|---------|---------|
| uuid | string | Unique message ID within conversation | `658ca84e-e655-4544-b63b-758a241a7d05` |
| sessionId | string | Conversation session ID (primary key) | `37134a38-e014-4319-bfb8-7b57cf032824` |
| parentUuid | string\|null | Previous message ID (forms chain) | `1e9899f6-3c84-4db1-86ba-5b64c386f892` |
| requestId | string | Anthropic API request ID | `req_011CX99xNdrmRU1nhHzbmh5F` |

### Context Information

| Field | Type | Purpose | Example |
|-------|------|---------|---------|
| cwd | string | Current working directory | `/Users/teazyou/dev/grimoire` |
| gitBranch | string | Git branch at message time | `main` |
| version | string | Claude Code version | `2.1.9` |
| slug | string | URL-friendly identifier | `flickering-cooking-hejlsberg` |

### Agent/Role Information

| Field | Type | Purpose | Example |
|-------|------|---------|---------|
| userType | string | Source type | `"external"` (user) or `"internal"` (system) |
| agentId | string | Subagent identifier | `a1027c4` |
| isSidechain | boolean | Is this a subagent conversation | true/false |

### Content Information

| Field | Type | Purpose | Example |
|-------|------|---------|---------|
| type | string | Message category | `"user"`, `"assistant"`, `"summary"`, `"file-history-snapshot"` |
| message.role | string | Message sender | `"user"` or `"assistant"` |
| isMeta | boolean | Is metadata/command | true for /clear, /command invocations |
| message.content | string\|array | Actual message content | Text or array of content objects |

### Model Information (assistant messages only)

| Field | Type | Purpose | Example |
|-------|------|---------|---------|
| model | string | LLM model used | `claude-opus-4-5-20251101` |
| id | string | Anthropic message ID | `msg_015LyscrGAYZPgVDX51CqCKP` |
| stop_reason | string\|null | Why generation stopped | `null` or `"end_turn"` |
| usage | object | Token counts | `{"input_tokens": 123, "output_tokens": 45}` |

### Timing

| Field | Type | Purpose | Format |
|-------|------|---------|--------|
| timestamp | string | Message creation time | ISO-8601 UTC: `2026-01-21T13:34:00.000Z` |

---

## Global Conversation History: history.jsonl

**Location:** `~/.claude/history.jsonl`
**Format:** JSONL (one entry per line)
**Purpose:** Global command and clipboard history across all projects

### Schema

```json
{
  "display": "string displayed to user",
  "pastedContents": {},
  "timestamp": 1767353535544,      // Unix timestamp in milliseconds
  "project": "/project/path",
  "sessionId": "uuid-string"
}
```

### Examples

**Paste entry:**
```json
{
  "display": "@request.md ",
  "pastedContents": {},
  "timestamp": 1767298711508,
  "project": "/Users/teazyou/workspace",
  "sessionId": "0885ac0a-fcd5-4d7b-b64d-a9baf7c950a7"
}
```

**Command entry:**
```json
{
  "display": "install vs code with brew please",
  "pastedContents": {},
  "timestamp": 1767297479108,
  "project": "/Users/teazyou",
  "sessionId": "db1ffd75-e4c5-4a51-bf5e-24e19c185fb0"
}
```

**Note:** This file tracks user interactions globally and is used for command palette history and recently accessed items.

---

## Task/Todo Storage: todos/ Folder

**Location:** `~/.claude/todos/`
**File naming:** `{sessionId}-agent-{agentId}.json`
**Purpose:** Task tracking for workflows

### Current Structure

Files are currently minimal:
```json
[]
```

Used by the **TodoWrite tool** to manage tasks during workflow execution. Each workflow can have its own task list tracked in this folder by sessionId.

---

## Differences: Main vs Sub-Agent Conversations

| Aspect | Main Conversation | Sub-Agent Conversation |
|--------|-------------------|----------------------|
| **Storage Location** | `{sessionId}.jsonl` | `{sessionId}/subagents/agent-{agentId}.jsonl` |
| **isSidechain** | `false` | `true` |
| **agentId** | Not present | Present |
| **sessionId** | Primary UUID | Inherited from parent |
| **parentUuid** | `null` (root) | UUID of spawning message |
| **Visibility** | Full conversation history | Isolated agent conversation |
| **Triggering** | Direct user input | Skill/tool invocation from main |
| **File size** | Larger (full history) | Smaller (isolated conversation) |
| **Independence** | Standalone | Dependent on parent context |

---

## File Size Patterns (Grimoire Project)

**Largest conversations:**
1. e031b65e-5bf0-4914-9487-0bae354319f5.jsonl - 9.3MB
2. facb6192-1f8f-4feb-a937-0fda6fe2f1be.jsonl - 3.5MB
3. 3e9116ae-398e-4a06-8816-da4ced7a3fd7.jsonl - 3.0MB
4. ea806e8b-59ae-4c18-b505-63666335de91.jsonl - 2.3MB
5. 37134a38-e014-4319-bfb8-7b57cf032824.jsonl - 1.8MB

**Pattern:** Each represents a distinct conversation session. Larger files indicate longer conversations with more tool usage and context accumulation.

---

## Key Implementation Observations

### 1. Session Continuity
- Main and subagent conversations share the same `sessionId`
- This enables efficient discovery and relationship tracking
- All messages in a subagent can be found by filtering `sessionId + isSidechain: true`

### 2. Message Chaining
- `parentUuid` field creates a linked-list structure
- Root messages have `parentUuid: null`
- Enables chronological reconstruction of conversation flow
- Supports branching through reply-to mechanisms

### 3. Atomic File Writes
- Debug logs show temp file creation + atomic rename pattern
- Prevents corruption of JSONL files during concurrent writes
- Example: `*.json.tmp.{pid}.{timestamp}` → atomic rename to final location

### 4. Project Organization
- Projects are stored by absolute path mapping
- Enables multi-project workflows and switching
- Path encoding uses `-` as separator in folder names

### 5. No Explicit Parent Link in Subagents
- **Critical finding:** Subagent files don't contain a "parent conversation ID"
- Discovery requires scanning the parent conversation for Skill invocations
- The `parentUuid` in subagent messages links to the spawning message, not the conversation ID
- This is a potential limitation for rapid subagent lookup

### 6. Tool Result Caching
- `{sessionId}/tool-results/` folder caches tool execution outputs
- Prevents redundant API calls
- Improves performance for repeated operations

---

## Actual Message Examples from Grimoire

### Example 1: User Input with Tool Invocation
```json
{
  "parentUuid": "1f7e8576-db2b-40f2-97b3-0ca4aed74a48",
  "isSidechain": false,
  "userType": "external",
  "cwd": "/Users/teazyou/dev/grimoire",
  "sessionId": "37134a38-e014-4319-bfb8-7b57cf032824",
  "version": "2.1.7",
  "gitBranch": "main",
  "message": {
    "role": "user",
    "content": [
      {
        "type": "text",
        "text": "IT IS CRITICAL THAT YOU FOLLOW THIS COMMAND: LOAD the FULL @_bmad/bmm/workflows/3-solutioning/create-architecture/workflow.md, READ its entire contents and follow its directions exactly!\n"
      }
    ]
  },
  "isMeta": true,
  "uuid": "2bda5a3c-313c-453a-aa37-848c941a435b",
  "timestamp": "2026-01-15T12:21:50.820Z"
}
```

### Example 2: Assistant Response with Tool Use
```json
{
  "parentUuid": "2bda5a3c-313c-453a-aa37-848c941a435b",
  "isSidechain": false,
  "userType": "external",
  "cwd": "/Users/teazyou/dev/grimoire",
  "sessionId": "37134a38-e014-4319-bfb8-7b57cf032824",
  "version": "2.1.7",
  "gitBranch": "main",
  "message": {
    "model": "claude-opus-4-5-20251101",
    "id": "msg_01FqUTUCmH6rUJyjV9Wf7cCR",
    "type": "message",
    "role": "assistant",
    "content": [
      {
        "type": "tool_use",
        "id": "toolu_01EaE5YagYJrKFwhJh6TbG6g",
        "name": "Read",
        "input": {
          "file_path": "/Users/teazyou/dev/grimoire/_bmad/bmm/workflows/3-solutioning/create-architecture/workflow.md"
        }
      }
    ]
  },
  "requestId": "req_011CX99x4ce4KFQfwsZNbZZ6",
  "type": "assistant",
  "uuid": "d47f80b3-54b8-49c0-bd38-5042fde86f14",
  "timestamp": "2026-01-15T12:21:54.791Z"
}
```

### Example 3: Subagent Message
```json
{
  "parentUuid": null,
  "isSidechain": true,
  "userType": "external",
  "cwd": "/Users/teazyou/dev/grimoire",
  "sessionId": "37134a38-e014-4319-bfb8-7b57cf032824",
  "version": "2.1.7",
  "gitBranch": "main",
  "agentId": "a1027c4",
  "slug": "flickering-cooking-hejlsberg",
  "type": "user",
  "message": {
    "role": "user",
    "content": "Research the best file/folder architecture patterns for codebases..."
  },
  "uuid": "message-uuid-here",
  "timestamp": "2026-01-15T12:21:50.820Z"
}
```

---

## Summary Table: File Structure Overview

| Component | Location | Format | Purpose |
|-----------|----------|--------|---------|
| Main conversations | `~/.claude/projects/-{project}/*.jsonl` | JSONL | Store conversation history per session |
| Subagent conversations | `~/.claude/projects/-{project}/{sessionId}/subagents/*.jsonl` | JSONL | Store spawned agent conversations |
| Tool results cache | `~/.claude/projects/-{project}/{sessionId}/tool-results/` | Files | Cache tool execution output |
| Global history | `~/.claude/history.jsonl` | JSONL | Command/paste history across projects |
| Debug logs | `~/.claude/debug/*.txt` | Text | Claude Code system logs |
| Task tracking | `~/.claude/todos/*.json` | JSON | Workflow task lists |
| File history | `~/.claude/file-history/{sessionId}/` | Files | File modification snapshots |
| Paste cache | `~/.claude/paste-cache/{sessionId}/` | Files | Clipboard history |
| Session env | `~/.claude/session-env/{sessionId}/` | Files | Environment snapshots |
| Shell snapshots | `~/.claude/shell-snapshots/` | Shell scripts | Shell environment capture |

---

## Implementation Notes for Integration

### Querying Conversations
To find all conversations for a project:
```
Pattern: ~/.claude/projects/-{absolute-path}/*.jsonl
Filter: Only files, not directories (those are subagent storage)
```

### Finding Sub-Agents
To find all subagents in a conversation:
```
1. Get {sessionId}
2. Scan {sessionId}.jsonl for messages with:
   - "type": "tool_use"
   - "name": "Skill"
3. Extract spawning message UUID
4. Look for {sessionId}/subagents/agent-*.jsonl
5. Filter messages by: sessionId + isSidechain: true + agentId match
```

### Linking Sub-Agent Results
Results are linked back via:
- Main conversation contains tool_use message
- Following message typically contains tool_result
- Subagent creates separate conversation with same sessionId
- Results bubble back through tool_use_id references

---

## Conclusion

Claude Code's conversation storage structure is highly organized for:
- **Multi-project support** via path-mapped project folders
- **Sub-agent isolation** through isSidechain markers and folder structure
- **Conversation history preservation** through JSONL format with UUID chaining
- **Fast lookup** through sessionId-based file organization
- **Context retention** through file-history snapshots and tool result caching

The key to understanding the system is recognizing that:
1. sessionId is the primary key for conversation grouping
2. isSidechain: true marks subagent conversations
3. Linking is through UUID chains (parentUuid) and shared sessionId
4. All storage is append-only JSONL for durability
5. Project mapping enables efficient multi-project workflows
