# PRD Document Alignment Review

## Summary
**Overall Assessment: MINOR ISSUES**

The PRD is largely aligned with the architecture decisions but has several gaps and inconsistencies that should be addressed. The PRD was written before some architecture decisions were finalized, resulting in missing details and some terminology inconsistencies.

## Decision-by-Decision Analysis

### 1. Session ID Management
- **Status:** PARTIAL
- **PRD References:** FR52, FR56, FR62, FR65, FR66
- **Notes:**
  - PRD correctly states session UUID generation (FR52) and session ID mapping (FR56)
  - However, PRD does not capture the critical decision that **DB entry is only created after Claude Code's first response/error** to prevent phantom sessions
  - PRD also doesn't explicitly document the hybrid approach where `.claude` folder is the source of truth for session existence while DB adds metadata
  - FR25 references `~/.claude/projects/` which contradicts the CLAUDE_CONFIG_DIR isolation decision (sessions should be in the app data folder, not home directory)

### 2. App Startup Pattern
- **Status:** PARTIAL
- **PRD References:** FR8-FR12, FR18
- **Notes:**
  - PRD describes startup verification steps but does not capture the **DB-First with Background Validation** pattern
  - Missing: Query DB first for fast session list display, background `.claude` folder scan, discrepancy flagging, notification of "discovered" sessions
  - The decision emphasizes fast startup by showing DB-cached sessions first, which is not reflected in the PRD

### 3. Instance Lifecycle
- **Status:** PARTIAL
- **PRD References:** FR54, FR55, FR57, FR67, Technical Success section (6-state machine mention)
- **Notes:**
  - PRD mentions "6-state machine" in passing (line 304) but doesn't define the states (Idle, Spawning, Working, Pending, Terminating, Error)
  - **Missing entirely:** Tiered Timeout system (10 min focused, 3 min unfocused, configurable)
  - **Missing:** Error categorization (network/transient auto-retry vs spawn failure vs Claude error vs crash/fatal)
  - **Missing:** Spawn strategy decision - instance spawns on **first keystroke**, not on send
  - PRD states "System stops child process when CC waits for user input" (FR54) which aligns with the Pending state concept
  - No mention of the "never close" option for timeout

### 4. UI/UX Indicators
- **Status:** PARTIAL
- **PRD References:** FR28, FR38, FR41, FR42
- **Notes:**
  - PRD has general indicator requirements but lacks the specific visual design decisions
  - **Missing:** Color bar + Icon + Animation triple redundancy pattern
  - **Missing:** Specific state indicators (no decoration for Idle, lightning bolt for Connected, animated dots for Working, warning for Error)
  - **Missing:** Completion notification pattern (flash highlight, red dot badge, optional sound)
  - **Missing:** 1-2s slow blink cycle for Working state
  - **Missing:** Yellow vs Red warning icon distinction (transient vs fatal errors)
  - FR42 mentions "Loading Claude Code" indicator which partially aligns with Spawning state

### 5. Stream Communication
- **Status:** PARTIAL
- **PRD References:** FR50, FR63, FR64, Non-Functional Requirements (Integration section)
- **Notes:**
  - PRD correctly mentions `--output-format stream-json` and `--session-id` arguments
  - PRD mentions NDJSON stream capture
  - **Missing:** Specific event types (init, message, tool_use, tool_result, result)
  - **Missing:** Known issue about final `result` event (GitHub #1920) and timeout mitigation
  - **Missing:** Buffered append (50-100ms batches) for streaming display
  - **Missing:** Response tracking object structure
  - **Missing:** Checkpoint + partial preserve for error recovery
  - PRD doesn't mention `--include-partial-messages` flag which is in the architecture decisions

### 6. Settings Architecture
- **Status:** ALIGNED
- **PRD References:** FR17, FR20-FR24, User Journey 3 (Plugin Manager)
- **Notes:**
  - PRD aligns well with the Obsidian-style settings pattern
  - Plugin enable/disable and per-plugin settings are covered
  - **Missing:** Explicit mention that settings are stored in DB (not files)
  - **Missing:** Schema-driven defaults concept
  - **Missing:** Immediate apply + undo pattern (no save button)
  - Generally aligned at the requirements level

### 7. Isolation (CLAUDE_CONFIG_DIR)
- **Status:** ALIGNED (with one inconsistency)
- **PRD References:** FR10, FR61, FR62, Non-Functional Requirements (Integration section)
- **Notes:**
  - PRD correctly uses `CLAUDE_CONFIG_DIR` terminology throughout
  - Correctly mentions "per-process env var" isolation
  - **Inconsistency:** FR25 states "User can view list of all CC sessions from ~/.claude/projects/" but sessions should be in the `CLAUDE_CONFIG_DIR` location (app data folder), not `~/.claude/`
  - PRD correctly mentions "platform-specific app data path" in integration requirements (line 540)
  - The isolation rationale (why not Docker, HOME override, or symlink swap) is not in PRD, which is appropriate for a PRD

### 8. Tab Behavior
- **Status:** PARTIAL
- **PRD References:** FR5, FR6, FR7, Non-Functional Requirements (Tab switching)
- **Notes:**
  - PRD covers basic tab functionality (multiple sessions, switching, splitting)
  - **Missing:** Explicit statement that one session = one tab maximum
  - **Missing:** Click behavior (focus existing tab if session already open)
  - **Missing:** Close while Working confirmation dialog details
  - **Missing:** App close behavior (all instances terminate, graceful shutdown)
  - PRD has FR57 (abort running process) but doesn't connect this to tab close scenarios

### 9. Data Export/Backup
- **Status:** ALIGNED
- **PRD References:** Growth Features section (line 149+)
- **Notes:**
  - PRD correctly defers export/sharing to post-MVP
  - "Sharing/export workflows" listed as Phase 3 feature
  - Aligns with decision that backup is not in MVP
  - Users can manually backup app data folder (this detail is in architecture but reasonably omitted from PRD)

## Issues Found

### Critical Issues
1. **FR25 path inconsistency:** States `~/.claude/projects/` but should reference `CLAUDE_CONFIG_DIR` location (app data folder) to align with isolation decision

### Missing Architecture Details (May need PRD updates)
2. **Tiered timeout system** (10 min/3 min/never close) is a significant UX feature not captured in PRD
3. **First keystroke spawn strategy** affects user experience and is not documented
4. **Session discovery** (background validation, notify user of discovered sessions) is missing
5. **Confirmation dialog for closing Working tabs** is missing
6. **State machine states** are referenced but not defined

### Minor Gaps (Acceptable for PRD level)
7. Stream event types and known issues - may be appropriate for technical spec rather than PRD
8. Visual indicator specifics (colors, animations) - may be appropriate for UX design rather than PRD
9. Response tracking object structure - appropriate for technical spec

## Recommendations

### Must Fix
1. **Update FR25** to reference `CLAUDE_CONFIG_DIR` folder instead of `~/.claude/projects/`

### Should Add
2. Add functional requirements for **tiered timeout** (this is a user-facing setting):
   - FR-NEW: "User can configure idle timeout for unfocused sessions (default: 3 minutes)"
   - FR-NEW: "User can configure idle timeout for focused sessions (default: 10 minutes)"
   - FR-NEW: "User can disable idle timeout for specific sessions"

3. Add functional requirement for **spawn on keystroke**:
   - FR-NEW: "System spawns child process when user starts typing in an inactive session"

4. Add functional requirements for **tab close behavior**:
   - FR-NEW: "System displays confirmation dialog when closing tab with Working session"
   - FR-NEW: "System terminates all child processes on application quit"

5. Add functional requirement for **session discovery**:
   - FR-NEW: "System notifies user of sessions discovered in config folder that are not in database"

### Consider Adding (Optional)
6. Define the 6 states in a requirements note or appendix: Idle, Spawning, Working, Pending, Terminating, Error
7. Add visual indicator details to a UX section if one is added later
